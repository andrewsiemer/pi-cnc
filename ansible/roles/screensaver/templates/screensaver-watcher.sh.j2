#!/bin/bash
# Siemer CNC Video Screensaver
# Simple idle detector - no xscreensaver needed
# Monitors input devices directly and plays video after timeout

VIDEO_PATH="{{ screensaver_video }}"
IDLE_TIMEOUT={{ (screensaver_timeout_minutes | int) * 60 + (screensaver_timeout_seconds | default(0) | int) }}

# Ensure we're outputting to the local display
export DISPLAY=:0
export XAUTHORITY="{{ pi_home }}/.Xauthority"
export XDG_RUNTIME_DIR="/run/user/$(id -u)"

VIDEO_PLAYING=0

log() {
    echo "[$(date '+%H:%M:%S')] $1"
}

stop_video() {
    if [ $VIDEO_PLAYING -eq 1 ]; then
        log "Stopping video"
        killall vlc 2>/dev/null
        VIDEO_PLAYING=0
    fi
}

start_video() {
    if [ $VIDEO_PLAYING -eq 0 ]; then
        log "Starting video screensaver"
        cvlc --fullscreen --loop --no-video-title-show --quiet "$VIDEO_PATH" &
        VIDEO_PLAYING=1
    fi
}

# Wait for any input on /dev/input devices
# Returns when input is detected
wait_for_input() {
    # Read from all input devices in parallel, return when any has data
    for dev in /dev/input/event*; do
        [ -r "$dev" ] && cat "$dev" 2>/dev/null &
    done | head -c1 >/dev/null
    # Kill remaining cat processes
    pkill -f "cat /dev/input" 2>/dev/null
}

log "Video screensaver starting (timeout: ${IDLE_TIMEOUT}s)"

while true; do
    # Wait for idle timeout
    log "Waiting ${IDLE_TIMEOUT}s for idle..."
    
    # Use a subshell with timeout to detect if input happens during idle wait
    if timeout "$IDLE_TIMEOUT" bash -c '
        for dev in /dev/input/event*; do
            [ -r "$dev" ] && cat "$dev" 2>/dev/null &
        done | head -c1 >/dev/null
    '; then
        # Input detected during wait - restart timer
        log "Activity detected, resetting timer"
        pkill -f "cat /dev/input" 2>/dev/null
        continue
    fi
    
    # Timeout reached - start video
    pkill -f "cat /dev/input" 2>/dev/null
    start_video
    
    # Wait for input to stop video
    log "Video playing, waiting for input..."
    wait_for_input
    
    stop_video
    log "Activity detected, video stopped"
    
    # Small delay before restarting idle detection
    sleep 1
done
