---
# Node.js, Yarn, and PM2 installation

# Node.js Installation
- name: Check if NodeSource GPG key exists
  stat:
    path: /etc/apt/keyrings/nodesource.gpg
  register: nodesource_key

- name: Create keyrings directory
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"

- name: Download NodeSource GPG key
  shell: |
    curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
  args:
    creates: /etc/apt/keyrings/nodesource.gpg
  when: not nodesource_key.stat.exists

- name: Add NodeSource repository
  apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_{{ nodejs_version }}.x nodistro main"
    state: present
    filename: nodesource

- name: Install Node.js
  apt:
    name: nodejs
    state: present
    update_cache: yes

- name: Verify Node.js installation
  command: node --version
  register: node_version
  changed_when: false

- name: Display Node.js version
  debug:
    msg: "Node.js version: {{ node_version.stdout }}"

# Yarn Installation
- name: Remove apt-installed yarn/yarnpkg (conflicts with npm version)
  apt:
    name:
      - yarn
      - yarnpkg
    state: absent
  ignore_errors: yes

- name: Remove leftover yarnpkg symlink
  file:
    path: /usr/bin/yarnpkg
    state: absent
  ignore_errors: yes

- name: Enable corepack for Yarn
  command: corepack enable
  changed_when: false

- name: Install Yarn globally via npm
  shell: npm install --global yarn --force
  args:
    creates: /usr/bin/yarn

- name: Verify Yarn installation
  command: yarn --version
  register: yarn_version
  changed_when: false

- name: Display Yarn version
  debug:
    msg: "Yarn version: {{ yarn_version.stdout }}"

# PM2 Installation
- name: Install PM2 globally
  npm:
    name: pm2
    global: yes
    state: present

- name: Verify PM2 installation
  command: pm2 --version
  register: pm2_version
  changed_when: false

- name: Display PM2 version
  debug:
    msg: "PM2 version: {{ pm2_version.stdout }}"

